<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
            height:200px;           
            overflow-y: scroll; 
            font-family: monospace, 'Courier New';
        }
    </style>
</head>
<body>
    <canvas id="myChart" width="1000" height="400"></canvas>
    <div class="container" id="rawOutput">      
    </div>
    <!--Script references. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <script src="Scripts/Chart.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>


    <!-- Our Script -->
    <script type="text/javascript">
        $(function () {

            var data = {
                labels: [],
                datasets: [
                    {
                        label: "Analog Values",
                        fillColor: "rgba(220,220,220,0.2)",
                        strokeColor: "rgba(220,220,220,1)",
                        pointColor: "rgba(220,220,220,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(220,220,220,1)",
                        data: []
                    }
                ]
            };

            // Declare a proxy to reference the hub.
            var viewhub = $.connection.viewHub;

            // Get our Chart            
            var ctx = $("#myChart").get(0).getContext("2d");
            var myLineChart = new Chart(ctx).Line(data, {"scaleOverride" : true, "scaleStartValue": 500, "scaleStepWidth": 100, "scaleSteps": 6 });


            // Create a function that the hub can call to broadcast messages.
            viewhub.client.Update = function (data) {
                // Html encode display name and message.
                var newmsg = $('<div />').text(data).html();
  
                // Add to chart
                var message = JSON.parse(data);
                if (message.messageType == "ADC") {
                    // Prep a time string for the X axis
                    var d = new Date();
                    var timeString = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();

                    // Calibrate for a light sensor (500 to 1200)                    
                    myLineChart.addData([message.value], timeString);
                }

                // Add the message to the debug view.
                var $outputPane = $('#rawOutput');
                $outputPane.prepend('<p><div style="display: none;">' + newmsg + '</div></p>').children().fadeIn('slow');
            };

            // Start the connection.
            $.connection.hub.start();
        });
    </script>
</body>
</html>